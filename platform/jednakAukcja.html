<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Interakcja z Aukcją</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="console-style.css">
  <script src="ethers.umd.js"></script>
</head>
<body>
  <button onclick="window.location.href = 'index.html'" style="margin-bottom:20px;">← Powrót</button>
  <div id="messageBox">Ładowanie...</div>
  <div id="contractFunctions"></div>

  <script>
    async function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const address = urlParams.get('adresAukcji');
      if (!address) {
        alert("Brak parametru adresAukcji w URL.");
        return;
      }

      if (!window.ethereum) {
        alert("Brak MetaMask.");
        return;
      }

      const provider = new ethers.BrowserProvider(window.ethereum);
      const network = await provider.getNetwork();
      if (network.chainId !== 42161n) {
        alert("Zła sieć Ethereum. Wybierz Arbitrum One z listy dostępnych w MetaMask.");
        return;
      }

      const signer = await provider.getSigner();
      const abi = await fetch("aukcja_v1.abi").then(r => r.json());
      const contract = new ethers.Contract(address, abi, signer);
      loadContractFunctions(contract, abi);
    }

    function stringifyWithBigInt(obj) {
      return JSON.stringify(obj, (_, value) =>
        typeof value === 'bigint' ? value.toString() : value,
        2
      );
    }

    const DANE_AUKCJI_FIELDS = [
      "tytul", "tworca", "linkOpisu", "linkRegulaminu", "linkDraftUmowy",
      "linkWymaganeDeklaracjeUzytkownika", "linkSpecyfikacjaTechniczna",
      "cenaMaksymalna", "wagaCena", "wagaGwarancja", "wagaCzas"
    ];

    const LINK_FIELDS = new Set([
      "linkOpisu",
      "linkRegulaminu",
      "linkDraftUmowy",
      "linkWymaganeDeklaracjeUzytkownika",
      "linkSpecyfikacjaTechniczna"
    ]);

    function formatDaneAukcji(dane) {
      let html = "<h2>Dane Aukcji:</h2><ul>";
      DANE_AUKCJI_FIELDS.forEach((field, index) => {
        let value = dane[field] ?? dane[index];
        if (typeof value === 'bigint') {
          value = value.toString();
        }
        if (LINK_FIELDS.has(field)) {
          html += `<li><strong>${field}</strong>: <a href="${value}" target="_blank">${value}</a></li>`;
        } else {
          html += `<li><strong>${field}</strong>: ${value}</li>`;
        }
      });
      html += "</ul>";
      return html;
    }

    async function loadContractFunctions(contract, abi) {
      const container = document.getElementById('contractFunctions');
      const output = document.getElementById('messageBox');
      container.innerHTML = '';

      abi.forEach(func => {
        if (func.type === "function") {
          const funcDiv = document.createElement('div');
          funcDiv.className = func.stateMutability;

          const button = document.createElement('button');
          button.textContent = func.name;
          button.className = func.stateMutability;

          const inputsDiv = document.createElement('div');
          func.inputs.forEach(input => {
            const inputLabel = document.createElement('label');
            inputLabel.textContent = input.name + ' (' + input.type + '): ';
            const inputElement = document.createElement('input');
            inputElement.setAttribute('id', func.name + '_' + input.name);
            inputElement.setAttribute('type', 'text');
            inputsDiv.appendChild(document.createElement('br'));
            inputsDiv.appendChild(inputLabel);
            inputsDiv.appendChild(inputElement);
          });

          button.addEventListener('click', async () => {
            const args = func.inputs.map(input => {
              return document.getElementById(func.name + '_' + input.name).value;
            });

            try {
              let result;
              if (func.stateMutability !== 'view' && func.stateMutability !== 'pure') {
                result = await contract[func.name](...args);
              } else {
                result = await contract[func.name](...args);
              }

              if (func.name === "taAukcja") {
                output.innerHTML = formatDaneAukcji(result);
              } else {
                output.innerText = stringifyWithBigInt(result);
              }
            } catch (error) {
              output.innerText = 'Error: ' + error.message;
            }
          });

          funcDiv.appendChild(button);
          funcDiv.appendChild(inputsDiv);
          container.appendChild(funcDiv);
        }
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
